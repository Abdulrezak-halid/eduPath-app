# GitLab CI/CD Pipeline for Edu Path

stages:
  - install
  - lint
  - test
  - build
  - deploy

variables:
  NODE_VERSION: "20"
  DOCKER_DRIVER: overlay2

# Cache
.cache_template: &cache_template
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - packages/backend/node_modules/
      - packages/frontend/node_modules/

# Install Dependencies
install:
  stage: install
  image: node:${NODE_VERSION}
  <<: *cache_template
  script:
    - npm install
    - cd packages/backend && npm install
    - cd ../frontend && npm install
  artifacts:
    expire_in: 1 hour
    paths:
      - node_modules/
      - packages/backend/node_modules/
      - packages/frontend/node_modules/

# Lint Backend
lint:backend:
  stage: lint
  image: node:${NODE_VERSION}
  <<: *cache_template
  dependencies:
    - install
  script:
    - cd packages/backend
    - npm run lint
  only:
    - merge_requests
    - main
    - develop

# Lint Frontend
lint:frontend:
  stage: lint
  image: node:${NODE_VERSION}
  <<: *cache_template
  dependencies:
    - install
  script:
    - cd packages/frontend
    - npm run lint
  only:
    - merge_requests
    - main
    - develop

# Test Backend (add when you have tests)
# test:backend:
#   stage: test
#   image: node:${NODE_VERSION}
#   <<: *cache_template
#   dependencies:
#     - install
#   script:
#     - cd packages/backend
#     - npm run test
#   coverage: '/Lines\s*:\s*(\d+\.\d+)%/'

# Test Frontend (add when you have tests)
# test:frontend:
#   stage: test
#   image: node:${NODE_VERSION}
#   <<: *cache_template
#   dependencies:
#     - install
#   script:
#     - cd packages/frontend
#     - npm run test
#   coverage: '/Lines\s*:\s*(\d+\.\d+)%/'

# Build Backend
build:backend:
  stage: build
  image: node:${NODE_VERSION}
  <<: *cache_template
  dependencies:
    - install
  script:
    - cd packages/backend
    - npm run build
  artifacts:
    expire_in: 1 week
    paths:
      - packages/backend/dist/
  only:
    - main
    - develop

# Build Frontend
build:frontend:
  stage: build
  image: node:${NODE_VERSION}
  <<: *cache_template
  dependencies:
    - install
  script:
    - cd packages/frontend
    - npm run build
  artifacts:
    expire_in: 1 week
    paths:
      - packages/frontend/dist/
  only:
    - main
    - develop

# Deploy to Development (configure your server)
# deploy:dev:
#   stage: deploy
#   image: alpine:latest
#   before_script:
#     - apk add --no-cache openssh-client
#     - eval $(ssh-agent -s)
#     - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
#     - mkdir -p ~/.ssh
#     - chmod 700 ~/.ssh
#   script:
#     - echo "Deploying to development server..."
#     # Add your deployment commands here
#   only:
#     - develop
#   when: manual

# Deploy to Production (configure your server)
# deploy:prod:
#   stage: deploy
#   image: alpine:latest
#   before_script:
#     - apk add --no-cache openssh-client
#     - eval $(ssh-agent -s)
#     - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
#   script:
#     - echo "Deploying to production server..."
#     # Add your deployment commands here
#   only:
#     - main
#   when: manual
