rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // ============================================================================
    // Helper Functions
    // ============================================================================
    
    /**
     * Check if user is authenticated
     */
    function isAuthenticated() {
      return request.auth != null;
    }
    
    /**
     * Check if file size is within limit
     */
    function isValidSize(maxSizeMB) {
      return request.resource.size < maxSizeMB * 1024 * 1024;
    }
    
    /**
     * Check if file is an image
     */
    function isImage() {
      return request.resource.contentType.matches('image/.*');
    }
    
    /**
     * Check if file is a document
     */
    function isDocument() {
      return request.resource.contentType in [
        'application/pdf',
        'application/msword',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'text/plain'
      ];
    }
    
    // ============================================================================
    // Profile Pictures
    // ============================================================================
    
    match /profile-pictures/{userId}/{fileName} {
      // Anyone can read profile pictures
      allow read: if true;
      
      // Users can upload their own profile picture
      allow create, update: if isAuthenticated() &&
                               request.auth.uid == userId &&
                               isImage() &&
                               isValidSize(5); // 5MB limit
      
      // Users can delete their own profile picture
      allow delete: if isAuthenticated() &&
                       request.auth.uid == userId;
    }
    
    // ============================================================================
    // Question Attachments
    // ============================================================================
    
    match /question-attachments/{questionId}/{fileName} {
      // Anyone can read question attachments
      allow read: if true;
      
      // Authenticated users can upload attachments
      allow create: if isAuthenticated() &&
                       (isImage() || isDocument()) &&
                       isValidSize(10); // 10MB limit
      
      // Only the uploader can delete
      allow delete: if isAuthenticated();
    }
    
    // ============================================================================
    // Answer Attachments
    // ============================================================================
    
    match /answer-attachments/{answerId}/{fileName} {
      // Anyone can read answer attachments
      allow read: if true;
      
      // Authenticated users can upload attachments
      allow create: if isAuthenticated() &&
                       (isImage() || isDocument()) &&
                       isValidSize(10); // 10MB limit
      
      // Only the uploader can delete
      allow delete: if isAuthenticated();
    }
    
    // ============================================================================
    // Advice Attachments
    // ============================================================================
    
    match /advice-attachments/{adviceId}/{fileName} {
      // Anyone can read advice attachments
      allow read: if true;
      
      // Authenticated users can upload attachments
      allow create: if isAuthenticated() &&
                       (isImage() || isDocument()) &&
                       isValidSize(10); // 10MB limit
      
      // Only the uploader can delete
      allow delete: if isAuthenticated();
    }
    
    // ============================================================================
    // Module Content (Admin Only)
    // ============================================================================
    
    match /module-content/{moduleId}/{fileName} {
      // Anyone can read module content
      allow read: if true;
      
      // Only authenticated users can upload
      // (In production, add admin check via Firestore lookup)
      allow write: if isAuthenticated();
    }
    
    // ============================================================================
    // Default: Deny All
    // ============================================================================
    
    // Deny access to any other paths
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
